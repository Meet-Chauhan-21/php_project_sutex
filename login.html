<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Login to VidyaGuru College - Access your student portal">
    <meta name="keywords" content="login, student, portal, VidyaGuru, college">
    <meta name="author" content="VidyaGuru College">
    <title>Login - VidyaGuru College</title>
    <link rel="stylesheet" href="assets/fonts-local.css">
    <link rel="stylesheet" href="assets/fontawesome-local.css?v=2024-icons">
    <link rel="stylesheet" href="new.css?v=2024">
    <link rel="stylesheet" href="assets/professional-enhancements.css">
    <link rel="stylesheet" href="assets/compact-design.css">
    <link rel="stylesheet" href="assets/auth-pages.css">
    <link rel="icon" type="image/svg+xml" href="cc_logo.svg">
    
    <!-- Google OAuth 2.0 API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <!-- Header -->
    <header id="header">
        <div class="container header-container">
            <a href="index.html" class="logo">
                <div class="logo-icon">VG</div>
                <span>VidyaGuru</span>
            </a>
            <nav id="nav" role="navigation" aria-label="Main navigation">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="index.html#programs">Programs</a></li>
                    <li><a href="index.html#features">Features</a></li>
                    <li><a href="index.html#testimonials">Reviews</a></li>
                    <li><a href="index.html#contact">Contact</a></li>
                    <li><a href="#" id="profileLink">Profile</a></li>
                </ul>
            </nav>
            <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Toggle mobile menu" aria-expanded="false">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Login Section -->
    <section class="auth-container">        
        <!-- Form Card -->
        <div class="auth-card">
            <h2>Login</h2>
            
            <form id="loginForm">
                <div class="form-group">
                    <input type="email" class="form-control" id="loginEmail" name="email" placeholder="Email" required>
                    <div class="error-message" id="emailError"></div>
                </div>
                
                <div class="form-group">
                    <div class="password-input-wrapper">
                        <input type="password" class="form-control" id="loginPassword" name="password" placeholder="Password" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')" title="Toggle password visibility">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                    </div>
                    <div class="error-message" id="passwordError"></div>
                </div>
                
                <div class="forgot-password">
                    <a href="#">Forgot password?</a>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    Login
                </button>
                
                <div class="auth-footer">
                    <p>Don't have an account? <a href="register.html">Signup</a></p>
                </div>
                
                <div class="auth-divider">
                    <span>Or</span>
                </div>
                
                <!-- Google Sign-In Button -->
                <div id="g_id_onload"
                     data-client_id="848381710448-e350700oj5m3qg8cjpiaif47hqmfi2ik.apps.googleusercontent.com"
                     data-callback="handleCredentialResponse"
                     data-auto_prompt="false">
                </div>
                
                <div class="g_id_signin" 
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="sign_in_with"
                     data-shape="rectangular"
                     data-logo_alignment="left">
                </div>

                <div class="auth-divider">
                    <span>Admin Access</span>
                </div>
                
                <button type="button" class="btn btn-admin" onclick="redirectToAdmin()">
                    <i class="fas fa-shield-alt"></i>
                    Admin Panel
                </button>
            </form>
        </div>
    </section>

    <script src="script.js"></script>
    <script src="auth.js"></script>
    <script>
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggle = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                toggle.classList.remove('fa-eye-slash');
                toggle.classList.add('fa-eye');
            } else {
                input.type = 'password';
                toggle.classList.remove('fa-eye');
                toggle.classList.add('fa-eye-slash');
            }
        }
        
        function redirectToAdmin() {
            // Add confirmation for admin access
            if (confirm('Redirecting to Admin Panel. This is for authorized administrators only. Continue?')) {
                window.location.href = 'admin.html';
            }
        }

        // Real Google OAuth 2.0 Functions
        function handleCredentialResponse(response) {
            console.log("Encoded JWT ID token: " + response.credential);
            
            // Optionally decode the JWT token locally for logging
            try {
                const payload = decodeJwtResponse(response.credential);
                console.log("ID: " + payload.sub);
                console.log('Full Name: ' + payload.name);
                console.log('Given Name: ' + payload.given_name);
                console.log('Family Name: ' + payload.family_name);
                console.log("Image URL: " + payload.picture);
                console.log("Email: " + payload.email);
            } catch (e) {
                console.warn('Failed to decode JWT locally:', e);
            }
            
            // Send only the credential to your server for verification
            authenticateWithGoogle(response.credential);
        }

        function decodeJwtResponse(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        async function authenticateWithGoogle(credential) {
            try {
                // Show loading state
                const googleButton = document.querySelector('.g_id_signin');
                if (googleButton) {
                    googleButton.style.opacity = '0.7';
                    googleButton.style.pointerEvents = 'none';
                }

                // Send to server for authentication
                const response = await fetch('php/google_auth.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ credential })
                });
                // Ensure JSON response; handle non-200 and non-JSON gracefully
                const contentType = response.headers.get('content-type') || '';
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`Server error ${response.status}: ${text.slice(0,200)}`);
                }
                if (!contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Unexpected response type. Expected JSON, got: ${contentType}. Body: ${text.slice(0,200)}`);
                }
                const result = await response.json();

                if (result.success) {
                    // Store user session
                    localStorage.setItem('userLoggedIn', 'true');
                    if (result.user) {
                        localStorage.setItem('userEmail', result.user.email || '');
                        localStorage.setItem('userName', result.user.full_name || result.user.first_name || '');
                        localStorage.setItem('userPicture', result.user.picture || '');
                        localStorage.setItem('userId', result.user.id || '');
                    }
                    localStorage.setItem('loginMethod', 'google');
                    
                    // Show success message
                    alert('Google login successful!');
                    
                    // Check if there's a redirect URL stored
                    const redirectUrl = localStorage.getItem('redirectAfterLogin');
                    if (redirectUrl) {
                        localStorage.removeItem('redirectAfterLogin');
                        window.location.href = redirectUrl;
                    } else {
                        // Redirect to profile or dashboard
                        window.location.href = 'profile.html';
                    }
                } else {
                    throw new Error(result.error || result.message || 'Google authentication failed');
                }
            } catch (error) {
                console.error('Google authentication error:', error);
                alert('Google login failed: ' + error.message);
                
                // Reset button state
                const googleButton = document.querySelector('.g_id_signin');
                if (googleButton) {
                    googleButton.style.opacity = '1';
                    googleButton.style.pointerEvents = 'auto';
                }
            }
        }

        // Initialize Google Sign-In when page loads
        window.onload = function() {
            // Initialize Google Sign-In
            google.accounts.id.initialize({
                client_id: "848381710448-e350700oj5m3qg8cjpiaif47hqmfi2ik.apps.googleusercontent.com",
                callback: handleCredentialResponse
            });
            
            // Render the button
            google.accounts.id.renderButton(
                document.querySelector('.g_id_signin'),
                { theme: "outline", size: "large" }
            );
        };

        function redirectToAdmin() {
            // Add confirmation for admin access
            if (confirm('Redirecting to Admin Panel. This is for authorized administrators only. Continue?')) {
                window.location.href = 'admin.html';
            }
        }
    </script>
    </script>
</body>
</html>